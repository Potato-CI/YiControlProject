name: YiControl Project GitHub Actions Demo
run-name: ${{ github.actor }} is Project out GitHub Actions ðŸš€
on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

env:
  gituser: "Potato"
  projectname: "YiControl"

jobs:

  yicontrol_build:
    runs-on: self-hosted
    container:
      image: rainbow12/x1_build:1.0.1 
    steps:

    - name: clean Project
      run: rm -rf ${{ env.projectname }}

    - name: install lib
      run: apt install -y libclang-dev clang

    - name: Clone YiControl repository
      run: git clone ${{ secrets.GITEA_HOST }}/${{ env.gituser }}/${{ env.projectname }}.git

    - name: Clone x1_base_util repository
      run: git clone ${{ secrets.GITEA_HOST }}/${{ env.gituser }}/x1_base_util.git ./YiControl/components/x1_base_util
    
    - name: Clone x1_rust_util repository
      run: git clone ${{ secrets.GITEA_HOST }}/${{ env.gituser }}/x1_rust_util.git ./YiControl/components/x1_rust_util

    - name: Download resources.h
      run: |
        mkdir YiControl/build
        cd YiControl/build
        curl http://${{ secrets.FTP_HOST }}:1234/resources.h -o resources.h
      shell: bash

    - name: build x1_rust_util
      run: |
        cd YiControl/components/x1_rust_util
        just build_esp
      shell: bash


    - name: Build project
      env:
        IDF_TARGET: esp32s3
        SDKCONFIG_DEFAULTS: sdkconfig.ci
      run: |
        python3 $IDF_PATH/tools/idf_tools.py install
        . $IDF_PATH/export.sh
        cd YiControl
        idf.py build
      shell: bash

    - name: rename build folder
      run: |
        rm -rf YiControl/build/esp-idf
        BUILD_DIR="build_$(date +%m%d%H%M)"
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        

    - name: Upload ftp
      uses: sebastianpopp/ftp-action@releases/v2
      with:
        host: ${{secrets.FTP_HOST}}
        user: ${{secrets.FTP_USER}}
        password: ${{secrets.FTP_PASS}}
        localDir: "YiControl/build"
        remoteDir: "/AiYiJan/YiControlProjectBin/${{ env.BUILD_DIR }}"
      
