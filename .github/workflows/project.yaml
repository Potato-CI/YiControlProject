name: YiControl Project GitHub Actions Demo
run-name: ${{ github.actor }} is Project out GitHub Actions ğŸš€
on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

env:
  gituser: "Potato"
  projectname: "YiControl"

jobs:

  yicontrol_build:
    runs-on: self-hosted
    container:
      image: rainbow12/x1_build:1.0.1 
    steps:
    
    - name: Clone YiControlPE repository
      run: git clone ${{ secrets.GITEA_HOST }}/${{ env.gituser }}/${{ env.projectname }}.git

    - name: Clone x1_base_util repository
      run: git clone ${{ secrets.GITEA_HOST }}/${{ env.gituser }}/x1_base_util.git ./YiControl/components/x1_base_util
    
    - name: Clone x1_rust_util repository
      run: git clone ${{ secrets.GITEA_HOST }}/${{ env.gituser }}/x1_rust_util.git ./YiControl/components/x1_rust_util
    
    - name: build x1_rust_util
      run: |
        cd YiControl/components/x1_rust_util
        just build_esp
      shell: bash

    - name: Download resources.h
      run: |
        mkdir YiControl/build
        cd YiControl/build
        url http://${{secrets.FTP_HOST}}:1234/resources.h -o resources.h
      shell: bash

    - name: Build project
      env:
        IDF_TARGET: esp32s3
      run: |
        . $IDF_PATH/export.sh
        cd YiControl
        idf.py build
      shell: bash

    # - name: rename build folder
    #   run: |
    #     rm -rf YiControlPE/build/esp-idf
    #     BUILD_DIR="build_$(date +%m%d%H%M)"
    #     echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        

    # - name: Upload ftp
    #   uses: sebastianpopp/ftp-action@releases/v2
    #   with:
    #     host: ${{secrets.FTP_HOST}}
    #     user: ${{secrets.FTP_USER}}
    #     password: ${{secrets.FTP_PASS}}
    #     localDir: "YiControlPE/build"
    #     remoteDir: "/AiYiJan/YiControlPEBin/${{ env.BUILD_DIR }}"
      




# name: ESP32-S3 (esp-rs no-std)

# on:
#   push:
#     branches: [ main ]
#   pull_request:

# env:
#   gituser: "Potato"
#   projectname: "x1_rust_util"
#   projectuiname: "YiControlPE_UI"

# jobs:
#   build-esp32s3:
#     runs-on: self-hosted
#     container:
#       image: espressif/idf:v5.2.5
#     steps:
#       - name: Install git
#         run: |
#           apt-get update && apt-get install -y git
#           rm -rf x1_rust_util
      
#       - name: Clone YiControlPE repository
#         run: git clone ${{ secrets.GITEA_HOST }}/${{ env.gituser }}/${{ env.projectname }}.git

#       # 1. å®‰è£… esp-rs å®˜æ–¹å·¥å…·é“¾ï¼ˆ2025 å¹´æœ€æ–°ç‰ˆï¼Œå·²ç»å®Œç¾æ”¯æŒ S3ï¼‰
#       - name: Install esp-rs toolchain
#         uses: esp-rs/xtensa-toolchain@v1.5
#         with:
#           # åªè£… S3 éœ€è¦çš„ç›®æ ‡ï¼Œé€Ÿåº¦æ›´å¿«
#           target: esp32s3
#           default: true
#           # å¯é€‰ï¼šåŒæ—¶å®‰è£… cargo-espflashã€espflash ç­‰å·¥å…·
#           tools: cargo-espflash,espflash,ldproxy

#       # 2. ç¼“å­˜ Cargo ä¾èµ–ï¼ˆè¶…çº§çœæ—¶é—´ï¼‰
#       - name: Cache cargo registry & git deps
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.cargo/registry
#             ~/.cargo/git
#             target
#           key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
#           restore-keys: |
#             ${{ runner.os }}-cargo-

#       # 3. ï¼ˆå¯é€‰ï¼‰å¦‚æœä½ é¡¹ç›®ç”¨çš„æ˜¯ https://github.com/esp-rs/esp-template
#       #    è¿™ä¸€æ­¥å¯ä»¥è‡ªåŠ¨å®‰è£… std è¡¥ä¸
#       - name: Run esp-template setup (if you use it)
#         if: contains(github.repository, 'esp-template') || hashFiles('esp-idf') == ''
#         run: |
#           cargo install esp-template
#           esp-template setup || true   # éƒ¨åˆ†æƒ…å†µä¸‹ä¼šæç¤ºå·²ç»å­˜åœ¨ï¼Œå¿½ç•¥å³å¯

#       # 4. ç¼–è¯‘ Release ç‰ˆæœ¬ï¼ˆæœ€å¸¸ç”¨ï¼‰
#       - name: Build Release (esp32s3)
#         run: |
#           cargo build --target esp32s3 --release



# jobs:
#   Explore-GitHub-Actions:
#     runs-on: self-hosted
#     container:
#       image: x1_new_build:latest
#       options: "--privileged -v /dev:/dev"
#     steps:
#     - name: Install Node (for act)
#       run: |
#         apt-get update && apt-get install -y nodejs npm



#     - name: Clone Gitea repo
#       run: |
#         cd /home
#         git clone https://${{ secrets.GITEA_TOKEN }}@git.zapotato.com/Potato/YiControl.git
#         git clone --depth 1 https://${{ secrets.GITEA_TOKEN }}@git.zapotato.com/Potato/x1_rust_util.git
#         git clone --depth 1 https://${{ secrets.GITEA_TOKEN }}@git.zapotato.com/Potato/x1_base_util.git  

#     # ç¼“å­˜ Cargo registry
#     - name: Cache cargo registry
#       uses: actions/cache@v4
#       with:
#         path: |
#           ~/.cargo/registry
#           ~/.cargo/git
#         key: ${{ runner.os }}-cargo-${{ hashFiles('/home/x1_rust_util/Cargo.lock') }}
#         restore-keys: |
#           ${{ runner.os }}-cargo-

#     # ç¼“å­˜ target
#     - name: Cache target
#       uses: actions/cache@v4
#       with:
#         path: target
#         key: ${{ runner.os }}-build-${{ hashFiles('/home/x1_rust_util/Cargo.lock') }}
#         restore-keys: |
#           ${{ runner.os }}-build-


#     - name: Build with proxy
#       run: |
#         cd /home/x1_rust_util
#         . /home/esp-idf/export.sh
#         just build_esp

#     - name: Debug repo status
#       run: |
#         cd /home
#         mkdir -p YiControl/components
#         cp -r x1_rust_util YiControl/components/
#         cp -r x1_base_util YiControl/components/
        
    

#     - name: edit Project Env
#       shell: sh -e {0}
#       env:
#         IDF_TARGET: esp32s3
#         SDKCONFIG_DEFAULTS: sdkconfig.ci
#         FTP_USER: ${{ secrets.FTP_USER }}
#         FTP_PASS: ${{ secrets.FTP_PASS }}
#         FTP_HOST: ${{ secrets.FTP_HOST }}
#       run: |
#         cd /home/YiControl
#         . /home/esp-idf/export.sh
#         mkdir -p /home/YiControl/build
#         wget -r -nH --cut-dirs=4 -P /home/YiControl/build/ ftp://$FTP_USER:$FTP_PASS@$FTP_HOST/AiYiJan/YiControlStaticBin/Static/bin
#         idf.py build




#     - name: flash Project
#       run: |
#         cd /home/YiControl
#         . /home/esp-idf/export.sh
#         esptool --chip esp32s3  erase_flash
#         esptool --chip esp32s3 -b 460800 write_flash 0x420000 /home/YiControl/build/resources.bin
#         idf.py flash


#     - name: mv Project bin file
#       run: |
#         mkdir -p /home/YiControlProjectBin
#         cp /home/YiControl/build/bootloader/bootloader.bin /home/YiControlProjectBin/
#         cp /home/YiControl/build/partition_table/partition-table.bin /home/YiControlProjectBin/
#         cp /home/YiControl/build/ota_data_initial.bin /home/YiControlProjectBin/
#         cp /home/YiControl/build/YiControl_*.bin /home/YiControlProjectBin/
#         cp /home/YiControl/build/storage.bin /home/YiControlProjectBin/
#         cp /home/YiControl/build/resources.bin /home/YiControlProjectBin/

#     - name: Upload bin files to FTP server
#       env:
#         FTP_USER: ${{ secrets.FTP_USER }}
#         FTP_PASS: ${{ secrets.FTP_PASS }}
#         FTP_HOST: ${{ secrets.FTP_HOST }}
#       run: |

#         cd /home
        
#         # æå–ç‰ˆæœ¬å·å’Œç”Ÿæˆæ—¥æœŸæ—¶é—´
#         VERSION=$(ls /home/YiControlProjectBin/YiControl_*.bin | head -1 | sed 's/.*YiControl_\(.*\)\.bin/\1/')
#         DATETIME=$(date +%m%d%H%M)
#         NEW_FOLDER_NAME="${VERSION}_${DATETIME}"
        
#         # é‡å‘½åæ–‡ä»¶å¤¹
#         mv YiControlProjectBin "$NEW_FOLDER_NAME"
#         ls -la "$NEW_FOLDER_NAME"
        
#         # ä¸Šä¼ æ•´ä¸ªæ–‡ä»¶å¤¹åˆ°FTPæœåŠ¡å™¨
#         lftp -c "
#           set ftp:ssl-allow no;
#           open -u $FTP_USER,$FTP_PASS $FTP_HOST;
#           mkdir -p AiYiJan/YiControlProjectBin;
#           cd AiYiJan/YiControlProjectBin;
#           mirror -R $NEW_FOLDER_NAME $NEW_FOLDER_NAME;
#           quit
#         "
    

    
    